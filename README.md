## 1С:Предприятие 8.3 клиент - сервер - Postgres 17 в Docker Compose

## Прочесть перед установкой!

<p>

Работа над репозиторием ~~к огромному сожалению~~ ещё не завершена. 
Готовых образов нет и, возможно, не будет из-за политики распространения 1С. 
Сборка дистрибутивов производится на вашей стороне. Все инструкции будут ниже.

</p>

<p>

~~На данный момент не удалось победить проблему лицензирования. 
А точнее раздачи лицензии сервером клиенту. Ресёрч в сети и использование ИИ не особо сдвинули процесс с мёртвой точки.~~

На самом деле это была не проблема, а просто недопонимание с моей стороны :) Лицензию нужно получать два раза:
- <b>На клиенте</b> при подключении к кластеру серверов (вручную с помощью GUI)
- <b>На сервере</b> при создании контейнера (автоматически с помощью [обработки](#получение-лицензии-на-сервере))

</p>

### Для чего и какие преимущества?
<p>

Образы, скрипты и обработка были созданы для "ленивого" деплоя и клиента, и сервера, 
и база данных с патчами от 1С на любом Linux хосте с установленным Docker Engine. На моей рабочей машине 
это Fedora 42 с X11 графическим сервером. Как дела обстоят с Wayland не знаю, нужно ресёрчить (либо не разворачивать 
клиент 1С в Docker, а подключаться с хоста).

</p>

<p>

После всей автоматизации запуск сервера и клиента может осуществляться командами `docker compose up/down/start/etc`. 
См. [документацию Docker Compose](https://docs.docker.com/compose). При этом на сервере в автоматическом режиме 
будет (ну или по крайней мере должно) происходить получение лицензий раз в 6-7 дней (на данном этапе только при 
первом или повторном запуске контейнера, но можно усовершенствовать для zero downtime).

</p>

### Инструкция по сборке и запуску образов
- [Скачать исходный код](https://codeload.github.com/alexandermyasnikov123/onec-community-docker/zip/refs/heads/master) данного репозитория
- [Установить Docker](https://docs.docker.com/engine/install/) на вашу Linux систему
- Скачать [дистрибутив 1С:Предприятие 8.3](https://developer.1c.ru/applications/Console?state=community) с поддержкой community лицензии
- Скопировать из скачанного дистрибутива файл `setup-full-8.3*.run` в директорию `/путь/до/исходного-кода/onec-community-docker/distr/`
- Изменить в файле `.env` следующие значения переменных: 
  1. `PLATFORM_VERSION` (версия дистрибутива, которую вы загрузили ранее) 
  2. `DEV_LOGIN` (логин от портала разработчиков)
  3. `DEV_PASSWORD` (пароль от портала разработчиков)
- Дать права на выполнение скрипту [first_init.sh](first_init.sh): `chmod +x first_init.sh`
- При первом запуске выполнить скрипт [first_init.sh](first_init.sh) от имени администратора: `sudo ./first_init.sh`
- При дальнейших запусках можете просто использовать команды `xhost +local:docker && docker compose (up, start, stop, down, etc)` 

### Получение лицензии на сервере
Автоматизировано. Выполняется программно с помощью [внешней обработки](ActivateCommunity.epf) и [скриптов активации](1c-server).
Файл сохраняется в директорию `/var/1C/license` с корректными правами доступа.

Логи сохраняются в папку `/1c_dir/activation` в контейнере сервера. Вы можете посмотреть их, подключившись к контейнеру напрямую,
либо добавить точку монтирования/volume к этой директории. 
<details>
  <summary>Основные логи выводятся в терминал и записываются в файлы</summary>
  
  ![img.png](screenshots/img.png)

</details>

### Подключение к серверу
<details>
  <summary>Данные для подключения к кластеру 1С:Предприятие из контейнера клиента</summary>

  Пароль пользователя базы данных: ***password***
  ![Снимок экрана от 2026-01-08 17-52-06.png](screenshots/connect_to_server.png)

</details>

### TODO:
1. ~~Решить проблему с невозможностью выдачи сервером лицензии клиенту~~ (Неактуально)
2. Улучшить автоматизацию автоматического продления лицензии
3. Сделать свой образ Postgres-1C с более гибкой возможностью кастомизации credentials
